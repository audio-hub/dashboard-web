<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitter Spaces Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex; /* Added for better layout */
            flex-wrap: wrap; /* Added for better layout */
            gap: 10px; /* Added for spacing */
            align-items: center; /* Added for alignment */
        }

        .controls input, .controls select, .controls button {
            padding: 12px;
            /* margin: 5px; Removed margin, using gap */
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .controls input {
            flex: 1;
            min-width: 300px;
        }

        .controls button {
            background: #1da1f2;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .controls button:hover {
            background: #1a91da;
        }

        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1da1f2;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .spaces-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .spaces-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .spaces-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .space-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .space-item:hover {
            background: #f8f9fa;
        }

        .space-item:last-child {
            border-bottom: none;
        }

        .space-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .space-host {
            color: #1da1f2;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .space-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .space-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-live {
            background: #ff4444;
            color: white;
        }

        .badge-ended {
            background: #666;
            color: white;
        }

        .badge-participants {
            background: #e3f2fd;
            color: #1976d2;
        }

        .space-actions {
            margin-top: 12px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            border: 1px solid #1da1f2;
            background: white;
            color: #1da1f2;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: #1da1f2;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #fcc;
        }

        .success {
            background: #efe;
            color: #060;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #cfc;
        }

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            width: 80%;
            max-width: 500px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-body pre {
            white-space: pre-wrap; /* Allows text to wrap */
            word-wrap: break-word; /* Breaks long words */
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            max-height: 300px; /* Limit height for scroll */
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls input {
                min-width: 100%;
                margin-bottom: 10px;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Twitter Spaces Dashboard</h1>
            <p>Monitor and explore Twitter Spaces activity</p>
        </div>

        <div class="controls">
            <input type="url" id="apiUrl" placeholder="Enter your API Gateway URL (e.g., https://xxx.execute-api.us-east-2.amazonaws.com/prod/)" value="https://46ziigjlif.execute-api.us-east-2.amazonaws.com/prod/">
            <button onclick="connectToAPI()">Connect to API</button>
            <button onclick="loadStats()">Refresh Stats</button>
        </div>

        <div id="stats-section" style="display: none;">
            <div class="stats-grid" id="statsGrid">
                </div>
        </div>

        <div class="spaces-container">
            <div class="spaces-header">
                <h2>üìª Spaces</h2>
                <div class="filter-controls">
                    <select id="statusFilter">
                        <option value="">All Spaces</option>
                        <option value="live">Live Only</option>
                        <option value="ended">Ended Only</option>
                    </select>
                    <select id="limitFilter">
                        <option value="10">Show 10</option>
                        <option value="25">Show 25</option>
                        <option value="50">Show 50</option>
                    </select>
                    <button onclick="loadSpaces()">Load Spaces</button>
                </div>
            </div>
            <div id="spacesContent">
                <div class="loading">
                    Enter your API URL above and click "Connect to API" to get started
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2>Space Details</h2>
            <div class="modal-body">
                <pre id="modalContent"></pre>
            </div>
        </div>
    </div>

    <script>
        let apiBaseUrl = 'https://46ziigjlif.execute-api.us-east-2.amazonaws.com/prod/';
        // This is the base URL for your S3 bucket where MP3 files are stored
        const s3BaseUrl = 'https://twitter-spaces-audio-streams-865712988605.s3.us-east-2.amazonaws.com/';
        let mp3FilesMap = {}; // Stores a map of slugified space keys to S3 MP3 URLs

        /**
         * Displays a temporary message (error or success) on the page.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('error' or 'success').
         */
        function showMessage(message, type = 'error') {
            const existing = document.querySelector('.error, .success');
            if (existing) existing.remove();

            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            document.querySelector('.container').insertBefore(div, document.querySelector('.spaces-container'));
            
            setTimeout(() => div.remove(), 5000);
        }

        /**
         * Opens the modal with the given title and content.
         * @param {string} title - The title for the modal.
         * @param {string} content - The content to display in the modal.
         */
        function openModal(title, content) {
            document.querySelector('#detailModal h2').textContent = title;
            document.getElementById('modalContent').textContent = content;
            document.getElementById('detailModal').style.display = 'flex'; // Use flex to center
        }

        /**
         * Closes the currently open modal.
         */
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        /**
         * Slugifies a given text string.
         * Used to create consistent keys for matching spaces with MP3 files.
         * @param {string} text - The input text.
         * @returns {string} The slugified text.
         */
        function slugify(text) {
            if (!text) return '';
            return String(text)
                .normalize('NFD') // Normalize diacritics
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .toLowerCase()
                .trim()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w-]+/g, '')       // Remove all non-word chars
                .replace(/--+/g, '-');         // Replace multiple - with single -
        }

        /**
         * Connects to the API, loads stats, spaces, and MP3 files.
         */
        async function connectToAPI() {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url) {
                showMessage('Please enter your API Gateway URL');
                return;
            }

            // Ensure URL ends with /
            apiBaseUrl = url.endsWith('/') ? url : url + '/';
            
            showMessage('Connected! Loading data...', 'success');
            await loadMp3Files(); // Load MP3 files first, as displaySpaces depends on them
            loadStats();
            loadSpaces();
        }

        /**
         * Makes an asynchronous request to the API endpoint.
         * @param {string} endpoint - The API endpoint to call.
         * @returns {Promise<Object>} The JSON response from the API.
         * @throws {Error} If the API base URL is not set or the request fails.
         */
        async function makeAPIRequest(endpoint) {
            if (!apiBaseUrl) {
                throw new Error('Please connect to API first');
            }

            const response = await fetch(apiBaseUrl + endpoint);
            if (!response.ok) {
                // Try to read error message from response body if available
                let errorDetails = response.statusText;
                try {
                    const errorJson = await response.json();
                    if (errorJson.message) {
                        errorDetails = errorJson.message;
                    }
                } catch (e) {
                    // Ignore JSON parsing error, use statusText
                }
                throw new Error(`HTTP ${response.status}: ${errorDetails}`);
            }
            
            return await response.json();
        }

        /**
         * Loads statistics from the API and displays them.
         */
        async function loadStats() {
            try {
                const data = await makeAPIRequest('stats');
                displayStats(data.data);
                document.getElementById('stats-section').style.display = 'block';
            } catch (error) {
                showMessage(`Failed to load stats: ${error.message}`);
                console.error('Stats error:', error);
            }
        }

        /**
         * Displays the fetched statistics in the dashboard.
         * @param {Object} stats - The statistics data.
         */
        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.overview.totalSpaces}</div>
                    <div class="stat-label">Total Spaces</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.overview.liveSpaces}</div>
                    <div class="stat-label">Live Spaces</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.overview.totalParticipants}</div>
                    <div class="stat-label">Total Participants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.activity.recentSpaces}</div>
                    <div class="stat-label">Recent (24h)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.overview.recordingCapable}</div>
                    <div class="stat-label">Recording Capable</div>
                </div>
            `;
        }

        /**
         * Loads MP3 file information from the API and populates the mp3FilesMap.
         */
        async function loadMp3Files() {
            try {
                const data = await makeAPIRequest('files');
                mp3FilesMap = {}; // Clear previous map

                if (data.files && Array.isArray(data.files)) {
                    data.files.forEach(file => {
                        const parts = file.name.split('/');
                        if (parts.length >= 3) {
                            const hostUsername = parts[0]; // e.g., 'garycardone'
                            const filename = parts[2]; // e.g., 'garycardone-Bitcoin-is-a-speculative-investment-w-GC-and-friends.mp3'

                            // Remove host username and .mp3 extension from filename to get the title slug part
                            let titleSlugPart = filename.replace(`${hostUsername}-`, '');
                            if (titleSlugPart.endsWith('.mp3')) {
                                titleSlugPart = titleSlugPart.slice(0, -4); // Remove .mp3
                            }
                            
                            // The key for mapping should be slugified host username + '-' + slugified title slug part
                            const key = slugify(hostUsername) + '-' + slugify(titleSlugPart);
                            mp3FilesMap[key] = s3BaseUrl + file.name;
                        }
                    });
                    console.log('MP3 files loaded and mapped:', mp3FilesMap);
                }
            } catch (error) {
                showMessage(`Failed to load MP3 file list: ${error.message}`);
                console.error('MP3 files error:', error);
            }
        }

        /**
         * Loads Twitter Spaces data from the API based on filters and displays them.
         */
        async function loadSpaces() {
            const spacesContent = document.getElementById('spacesContent');
            spacesContent.innerHTML = '<div class="loading">Loading spaces...</div>';

            try {
                const status = document.getElementById('statusFilter').value;
                const limit = document.getElementById('limitFilter').value;
                
                let endpoint = 'spaces?';
                const params = [];
                if (limit) params.push(`limit=${limit}`);
                if (status) params.push(`status=${status}`);
                endpoint += params.join('&');

                const data = await makeAPIRequest(endpoint);
                displaySpaces(data.data);
            } catch (error) {
                spacesContent.innerHTML = `<div class="error">Failed to load spaces: ${error.message}</div>`;
                console.error('Spaces error:', error);
            }
        }

        /**
         * Displays the fetched Twitter Spaces in the dashboard.
         * @param {Array<Object>} spaces - An array of Twitter Space objects.
         */
        function displaySpaces(spaces) {
            const spacesContent = document.getElementById('spacesContent');
            
            if (!spaces || spaces.length === 0) {
                spacesContent.innerHTML = '<div class="loading">No spaces found</div>';
                return;
            }

            spacesContent.innerHTML = spaces.map(space => {
                // Generate a key for the space to look up in mp3FilesMap
                // Use the host's username and the space's title, both slugified.
                const spaceKey = slugify(space.host?.username || '') + '-' + slugify(space.title || '');
                const mp3Url = mp3FilesMap[spaceKey];
                
                return `
                    <div class="space-item">
                        <div class="space-title">${space.title || 'Untitled Space'}</div>
                        <div class="space-host">
                            üéôÔ∏è ${space.host?.displayName || space.host?.username || 'Unknown Host'}
                            ${space.host?.username ? `(@${space.host.username})` : ''}
                        </div>
                        <div class="space-meta">
                            <span class="space-badge ${space.isLive ? 'badge-live' : 'badge-ended'}">
                                ${space.isLive ? 'üî¥ LIVE' : '‚ö´ ENDED'}
                            </span>
                            <span class="space-badge badge-participants">
                                üë• ${space.participantCount || 0} participants
                            </span>
                            ${space.recordingStatus ? `<span class="space-badge badge-participants">üìπ ${space.recordingStatus}</span>` : ''}
                        </div>
                        <div class="space-actions">
                            <button class="btn-small" onclick="viewSpaceDetails('${space._id}')">View Details</button>
                            <button class="btn-small" onclick="viewParticipants('${space._id}')">View Participants</button>
                            ${mp3Url ? `<button class="btn-small" onclick="window.open('${mp3Url}', '_blank')">üéß Listen</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Fetches and displays detailed information for a specific space.
         * @param {string} spaceId - The ID of the space to view.
         */
        async function viewSpaceDetails(spaceId) {
            try {
                const data = await makeAPIRequest(`spaces/${spaceId}`);
                const space = data.data;
                
                const details = `
Space: ${space.title || 'Untitled'}
Host: ${space.host?.displayName || space.host?.username || 'Unknown'}
Status: ${space.isLive ? 'LIVE' : 'ENDED'}
Participants: ${space.participantCount || 0}
Created: ${space.createdAt ? new Date(space.createdAt).toLocaleString() : 'Unknown'}
Updated: ${space.lastUpdated ? new Date(space.lastUpdated).toLocaleString() : 'Unknown'}
${space.hlsUrl ? `\nStream URL: ${space.hlsUrl}` : ''}
${space.description ? `\nDescription: ${space.description}` : ''}
                `.trim();
                
                openModal('Space Details', details); // Use modal instead of alert
            } catch (error) {
                showMessage(`Failed to load space details: ${error.message}`);
            }
        }

        /**
         * Fetches and displays the list of participants for a specific space.
         * @param {string} spaceId - The ID of the space to view participants for.
         */
        async function viewParticipants(spaceId) {
            try {
                const data = await makeAPIRequest(`spaces/${spaceId}/participants`);
                const participants = data.participants || [];
                
                if (participants.length === 0) {
                    openModal('Participants', 'No participants found for this space'); // Use modal
                    return;
                }
                
                const participantsList = participants
                    .map(p => `${p.name || p.username || 'Unknown'} (${p.role || 'listener'})`)
                    .join('\n');
                
                openModal(`Participants in "${data.spaceTitle || 'Space'}"`, participantsList); // Use modal
            } catch (error) {
                showMessage(`Failed to load participants: ${error.message}`);
            }
        }

        // Auto-connect if URL is in localStorage
        window.addEventListener('load', () => {
            const savedUrl = localStorage.getItem('spacesApiUrl');
            if (savedUrl) {
                document.getElementById('apiUrl').value = savedUrl;
                // Automatically connect on load if a URL is saved
                connectToAPI();
            }
        });

        // Save URL to localStorage when API URL input changes
        document.getElementById('apiUrl').addEventListener('change', (e) => {
            localStorage.setItem('spacesApiUrl', e.target.value);
        });

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>